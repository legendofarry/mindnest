rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAllowedRole(role) {
      return role in [
        'individual',
        'student',
        'staff',
        'counselor',
        'admin',
        'institutionAdmin',
        'other'
      ];
    }
    

    function authEmail() {
      return request.auth.token.email;
    }

    function currentUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function currentUserRole() {
      return currentUserDoc().role;
    }

    function currentInstitutionId() {
      return currentUserDoc().institutionId;
    }

    function isOwnerAccount() {
      return isSignedIn() &&
        request.auth.token.email == 'karimiarrison@gmail.com';
    }

    function isDevClearAccount() {
      return isSignedIn() &&
        request.auth.token.email == 'legendofarrie@gmail.com';
    }

    function currentInstitutionApproved() {
      return isSignedIn() &&
        currentInstitutionId() != null &&
        exists(/databases/$(database)/documents/institutions/$(currentInstitutionId())) &&
        institutionStatusIsApproved(
          get(/databases/$(database)/documents/institutions/$(currentInstitutionId())).data
        );
    }

    function institutionStatusIsApproved(data) {
      return !('status' in data) || data.status == 'approved';
    }

    function institutionJoinCodeChangedKeys() {
      return request.resource.data.diff(resource.data).changedKeys();
    }

    function joinCodeMetadataKeys() {
      return [
        'joinCode',
        'joinCodeCreatedAt',
        'joinCodeExpiresAt',
        'joinCodeUsageCount',
        'updatedAt'
      ];
    }

    function sameInstitutionAdmin(institutionId) {
      return isSignedIn() &&
        currentUserRole() == 'institutionAdmin' &&
        currentInstitutionId() == institutionId;
    }

    function canAdminRegenerateInstitutionCode(institutionId) {
      return sameInstitutionAdmin(institutionId) &&
        institutionStatusIsApproved(resource.data) &&
        institutionJoinCodeChangedKeys().hasOnly(joinCodeMetadataKeys()) &&
        request.resource.data.createdBy == resource.data.createdBy &&
        request.resource.data.name == resource.data.name &&
        request.resource.data.joinCodeUsageCount == 0 &&
        request.resource.data.joinCode != resource.data.joinCode;
    }

    function canJoinFlowIncrementUsage(institutionId) {
      return isSignedIn() &&
        institutionStatusIsApproved(resource.data) &&
        institutionJoinCodeChangedKeys().hasOnly(['joinCodeUsageCount', 'updatedAt']) &&
        request.resource.data.joinCode == resource.data.joinCode &&
        request.resource.data.joinCodeCreatedAt == resource.data.joinCodeCreatedAt &&
        request.resource.data.joinCodeExpiresAt == resource.data.joinCodeExpiresAt &&
        request.resource.data.joinCodeUsageCount == resource.data.joinCodeUsageCount + 1 &&
        existsAfter(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.institutionId == institutionId &&
        getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['student', 'staff'] &&
        existsAfter(/databases/$(database)/documents/institution_members/$(institutionId + '_' + request.auth.uid)) &&
        getAfter(/databases/$(database)/documents/institution_members/$(institutionId + '_' + request.auth.uid)).data.userId == request.auth.uid &&
        getAfter(/databases/$(database)/documents/institution_members/$(institutionId + '_' + request.auth.uid)).data.institutionId == institutionId;
    }

    function canAutoRotateExpiredOrCappedCode() {
      return isSignedIn() &&
        institutionStatusIsApproved(resource.data) &&
        institutionJoinCodeChangedKeys().hasOnly(joinCodeMetadataKeys()) &&
        request.resource.data.joinCodeUsageCount == 0 &&
        request.resource.data.joinCode != resource.data.joinCode &&
        request.resource.data.createdBy == resource.data.createdBy &&
        request.resource.data.name == resource.data.name &&
        (
          !('joinCodeExpiresAt' in resource.data) ||
          request.time >= resource.data.joinCodeExpiresAt ||
          (
            'joinCodeUsageCount' in resource.data &&
            resource.data.joinCodeUsageCount >= 50
          )
        );
    }

    function sharesInstitutionWithUser(targetUid) {
      return isSignedIn() &&
        currentInstitutionId() != null &&
        exists(/databases/$(database)/documents/institution_members/$(currentInstitutionId() + '_' + targetUid));
    }

    function isLiveRole() {
      return currentUserRole() in ['student', 'staff', 'counselor'];
    }

    function liveSessionDoc(sessionId) {
      return get(/databases/$(database)/documents/live_sessions/$(sessionId)).data;
    }

    function canAccessLiveSession(sessionId) {
      return isSignedIn() &&
        currentInstitutionId() != null &&
        liveSessionDoc(sessionId).institutionId == currentInstitutionId() &&
        (
          liveSessionDoc(sessionId).createdBy == request.auth.uid ||
          currentUserRole() in liveSessionDoc(sessionId).allowedRoles
        );
    }

    match /users/{uid} {
      allow read: if isOwner(uid) ||
        resource.data.email == 'karimiarrison@gmail.com';
      allow create: if isOwner(uid) &&
        isAllowedRole(request.resource.data.role) &&
        request.resource.data.role in ['individual', 'institutionAdmin'];
      allow update: if isOwner(uid) &&
        isAllowedRole(request.resource.data.role) &&
        (
          request.resource.data.role in ['individual', 'student', 'staff', 'counselor'] ||
          request.resource.data.role == resource.data.role
        );
      allow delete: if isOwner(uid);
    }

    match /institutions/{institutionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.createdBy == request.auth.uid;
      allow update: if canAdminRegenerateInstitutionCode(institutionId) ||
        canJoinFlowIncrementUsage(institutionId) ||
        canAutoRotateExpiredOrCappedCode();
      allow delete: if false;
    }

    match /institution_members/{membershipId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.role in ['student', 'staff', 'counselor', 'institutionAdmin'];
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    match /user_invites/{inviteId} {
      allow create: if isSignedIn() &&
        currentUserRole() == 'institutionAdmin' &&
        currentInstitutionApproved() &&
        request.resource.data.institutionId == currentInstitutionId() &&
        request.resource.data.intendedRole in ['student', 'staff', 'counselor'] &&
        request.resource.data.status == 'pending';
      allow read: if isSignedIn() && (
        (currentUserRole() == 'institutionAdmin' &&
          resource.data.institutionId == currentInstitutionId()) ||
        (authEmail() != null && resource.data.invitedEmail == authEmail())
      );
      allow update: if isSignedIn() &&
        authEmail() != null &&
        resource.data.invitedEmail == authEmail() &&
        resource.data.status == 'pending' &&
        request.resource.data.status in ['accepted', 'declined'] &&
        request.resource.data.invitedEmail == resource.data.invitedEmail &&
        request.resource.data.intendedRole == resource.data.intendedRole &&
        request.resource.data.institutionId == resource.data.institutionId;
      allow delete: if false;
    }

    match /counselor_invites/{inviteId} {
      allow create: if isSignedIn() &&
        currentUserRole() == 'institutionAdmin' &&
        currentInstitutionApproved() &&
        request.resource.data.institutionId == currentInstitutionId() &&
        request.resource.data.role == 'counselor';
      allow read: if isSignedIn() &&
        currentUserRole() == 'institutionAdmin' &&
        resource.data.institutionId == currentInstitutionId();
      allow update, delete: if false;
    }

    match /school_requests/{requestId} {
      allow create: if request.resource.data.schoolName is string &&
        request.resource.data.schoolName.size() >= 2 &&
        request.resource.data.mobileNumber is string &&
        request.resource.data.mobileNumber.size() >= 6 &&
        request.resource.data.status == 'pending';
      allow read, update, delete: if isOwnerAccount();
    }

    match /onboarding_responses/{responseId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    match /counselor_profiles/{counselorId} {
      allow read: if isSignedIn() &&
        (
          sharesInstitutionWithUser(counselorId) ||
          resource.data.institutionId == currentInstitutionId()
        );
      allow create, update: if isSignedIn() &&
        currentUserRole() == 'counselor' &&
        counselorId == request.auth.uid &&
        request.resource.data.institutionId == currentInstitutionId();
      allow delete: if false;
    }

    match /counselor_availability/{slotId} {
      allow read: if isSignedIn() &&
        resource.data.institutionId == currentInstitutionId();
      allow create: if isSignedIn() &&
        currentUserRole() == 'counselor' &&
        request.resource.data.counselorId == request.auth.uid &&
        request.resource.data.institutionId == currentInstitutionId() &&
        request.resource.data.status == 'available';
      allow update: if isSignedIn() &&
        request.resource.data.counselorId == resource.data.counselorId &&
        request.resource.data.institutionId == resource.data.institutionId &&
        (
          (
            currentUserRole() == 'counselor' &&
            resource.data.counselorId == request.auth.uid
          ) ||
          (
            resource.data.status == 'available' &&
            request.resource.data.status == 'booked' &&
            request.resource.data.bookedBy == request.auth.uid &&
            currentInstitutionId() == resource.data.institutionId
          ) ||
          (
            resource.data.status == 'booked' &&
            resource.data.bookedBy == request.auth.uid &&
            request.resource.data.status == 'available'
          )
        );
      allow delete: if isSignedIn() &&
        currentUserRole() == 'counselor' &&
        resource.data.counselorId == request.auth.uid &&
        resource.data.status == 'available';
    }

    match /appointments/{appointmentId} {
      allow read: if isSignedIn() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.counselorId == request.auth.uid ||
        (
          currentUserRole() == 'institutionAdmin' &&
          resource.data.institutionId == currentInstitutionId()
        )
      );
      allow create: if isSignedIn() &&
        request.resource.data.studentId == request.auth.uid &&
        request.resource.data.institutionId == currentInstitutionId() &&
        currentUserRole() in ['student', 'staff', 'individual'] &&
        request.resource.data.status in ['pending', 'confirmed'] &&
        request.resource.data.rated == false;
      allow update: if isSignedIn() &&
        request.resource.data.institutionId == resource.data.institutionId &&
        request.resource.data.studentId == resource.data.studentId &&
        request.resource.data.counselorId == resource.data.counselorId &&
        request.resource.data.slotId == resource.data.slotId &&
        (
          (
            resource.data.studentId == request.auth.uid &&
            resource.data.status in ['pending', 'confirmed'] &&
            request.resource.data.status == 'cancelled'
          ) ||
          (
            resource.data.studentId == request.auth.uid &&
            resource.data.status == 'completed' &&
            resource.data.rated != true &&
            request.resource.data.status == 'completed' &&
            request.resource.data.rated == true
          ) ||
          (
            resource.data.counselorId == request.auth.uid &&
            request.resource.data.status in ['confirmed', 'completed', 'cancelled', 'noShow']
          ) ||
          (
            currentUserRole() == 'institutionAdmin' &&
            resource.data.institutionId == currentInstitutionId()
          )
        );
      allow delete: if false;
    }

    match /notifications/{notificationId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() &&
        request.resource.data.institutionId == currentInstitutionId();
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    match /user_push_tokens/{tokenId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.token is string &&
        request.resource.data.token.size() > 0;
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId &&
        request.resource.data.token == resource.data.token;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    match /user_notification_settings/{uid} {
      allow read, create, update: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    match /user_privacy_settings/{uid} {
      allow read, create, update: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    match /care_goals/{goalId} {
      allow read: if isSignedIn() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.counselorId == request.auth.uid ||
        (
          currentUserRole() == 'institutionAdmin' &&
          resource.data.institutionId == currentInstitutionId()
        )
      );
      allow create: if isSignedIn() &&
        currentUserRole() == 'counselor' &&
        request.resource.data.counselorId == request.auth.uid &&
        request.resource.data.institutionId == currentInstitutionId();
      allow update: if isSignedIn() && (
        (
          resource.data.studentId == request.auth.uid &&
          request.resource.data.studentId == resource.data.studentId &&
          request.resource.data.counselorId == resource.data.counselorId &&
          request.resource.data.institutionId == resource.data.institutionId
        ) ||
        (
          resource.data.counselorId == request.auth.uid &&
          request.resource.data.counselorId == resource.data.counselorId &&
          request.resource.data.studentId == resource.data.studentId &&
          request.resource.data.institutionId == resource.data.institutionId
        )
      );
      allow delete: if false;
    }

    match /live_sessions/{sessionId} {
      allow read: if isSignedIn() &&
        currentInstitutionId() != null &&
        resource.data.institutionId == currentInstitutionId();

      allow create: if isSignedIn() &&
        isLiveRole() &&
        request.resource.data.institutionId == currentInstitutionId() &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.hostRole == currentUserRole() &&
        request.resource.data.status == 'live' &&
        request.resource.data.maxGuests == 20 &&
        request.resource.data.allowedRoles is list;

      allow update: if isSignedIn() &&
        currentInstitutionId() != null &&
        resource.data.institutionId == currentInstitutionId() &&
        (
          (
            resource.data.createdBy == request.auth.uid &&
            request.resource.data.createdBy == resource.data.createdBy &&
            request.resource.data.institutionId == resource.data.institutionId
          ) ||
          (
            exists(/databases/$(database)/documents/live_sessions/$(sessionId)/participants/$(request.auth.uid)) &&
            request.resource.data.createdBy == resource.data.createdBy &&
            request.resource.data.institutionId == resource.data.institutionId &&
            request.resource.data.status == resource.data.status &&
            request.resource.data.title == resource.data.title &&
            request.resource.data.description == resource.data.description &&
            request.resource.data.allowedRoles == resource.data.allowedRoles &&
            request.resource.data.maxGuests == resource.data.maxGuests &&
            request.resource.data.likeCount == resource.data.likeCount + 1
          )
        );

      allow delete: if false;

      match /participants/{uid} {
        allow read: if canAccessLiveSession(sessionId);

        allow create: if isSignedIn() &&
          uid == request.auth.uid &&
          canAccessLiveSession(sessionId) &&
          liveSessionDoc(sessionId).status in ['live', 'paused'] &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.role == currentUserRole();

        allow update: if canAccessLiveSession(sessionId) &&
          (
            uid == request.auth.uid ||
            liveSessionDoc(sessionId).createdBy == request.auth.uid
          );

        allow delete: if canAccessLiveSession(sessionId) &&
          (
            uid == request.auth.uid ||
            liveSessionDoc(sessionId).createdBy == request.auth.uid
          );
      }

      match /mic_requests/{uid} {
        allow read: if canAccessLiveSession(sessionId);

        allow create: if isSignedIn() &&
          uid == request.auth.uid &&
          canAccessLiveSession(sessionId) &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.status == 'pending';

        allow update: if canAccessLiveSession(sessionId) &&
          (
            uid == request.auth.uid ||
            liveSessionDoc(sessionId).createdBy == request.auth.uid
          );

        allow delete: if canAccessLiveSession(sessionId) &&
          (
            uid == request.auth.uid ||
            liveSessionDoc(sessionId).createdBy == request.auth.uid
          );
      }

      match /comments/{commentId} {
        allow read: if canAccessLiveSession(sessionId);

        allow create: if canAccessLiveSession(sessionId) &&
          exists(/databases/$(database)/documents/live_sessions/$(sessionId)/participants/$(request.auth.uid)) &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.text is string &&
          request.resource.data.text.size() > 0 &&
          request.resource.data.text.size() <= 250;

        allow update: if false;

        allow delete: if canAccessLiveSession(sessionId) &&
          (
            resource.data.userId == request.auth.uid ||
            liveSessionDoc(sessionId).createdBy == request.auth.uid
          );
      }

      match /reactions/{reactionId} {
        allow read: if canAccessLiveSession(sessionId);
        allow create: if canAccessLiveSession(sessionId) &&
          exists(/databases/$(database)/documents/live_sessions/$(sessionId)/participants/$(request.auth.uid)) &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.emoji is string &&
          request.resource.data.emoji.size() > 0 &&
          request.resource.data.emoji.size() <= 8;
        allow update, delete: if false;
      }

      match /comment_reports/{reportId} {
        allow create: if canAccessLiveSession(sessionId) &&
          exists(/databases/$(database)/documents/live_sessions/$(sessionId)/participants/$(request.auth.uid));
        allow read: if canAccessLiveSession(sessionId) &&
          (
            liveSessionDoc(sessionId).createdBy == request.auth.uid ||
            currentUserRole() == 'institutionAdmin'
          );
        allow update, delete: if false;
      }
    }

    match /counselor_ratings/{ratingId} {
      allow read: if isSignedIn() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.counselorId == request.auth.uid
      );
      allow create: if isSignedIn() &&
        ratingId == request.resource.data.appointmentId &&
        !exists(/databases/$(database)/documents/counselor_ratings/$(ratingId)) &&
        request.resource.data.studentId == request.auth.uid &&
        request.resource.data.rating is int &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5 &&
        exists(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)) &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.studentId == request.auth.uid &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.counselorId == request.resource.data.counselorId &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.institutionId == request.resource.data.institutionId &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.status == 'completed';
      allow update, delete: if false;
    }

    match /counselor_public_ratings/{ratingId} {
      allow read: if isSignedIn() &&
        resource.data.institutionId == currentInstitutionId();
      allow create: if isSignedIn() &&
        currentUserRole() == 'student' &&
        ratingId == request.resource.data.appointmentId &&
        !exists(/databases/$(database)/documents/counselor_public_ratings/$(ratingId)) &&
        request.resource.data.studentId == request.auth.uid &&
        request.resource.data.institutionId == currentInstitutionId() &&
        request.resource.data.rating is int &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5 &&
        exists(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)) &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.studentId == request.auth.uid &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.counselorId == request.resource.data.counselorId &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.institutionId == currentInstitutionId() &&
        get(/databases/$(database)/documents/appointments/$(request.resource.data.appointmentId)).data.status == 'completed';
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if isOwnerAccount() || isDevClearAccount();
    }
  }
}
